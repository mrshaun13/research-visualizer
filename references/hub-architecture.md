# Research Hub Architecture

The Research Hub is a single web application that hosts all research projects generated by the research-visualizer skill. Instead of scaffolding a new standalone Vite project for each research topic, all projects live under one hub with a unified navigation experience.

## Config File

**Location:** `~/.codeium/windsurf/skills/research-visualizer/config.json`

This file is the **installation detection marker**. If it exists, the hub has been set up. If it doesn't exist, this is a first-time run.

### Schema

```json
{
  "version": "1.0",
  "created": "2026-02-09T20:00:00Z",
  "hubPath": "/home/user/research-hub",
  "port": 5180,
  "gitRepo": "git@github.com:user/their-hub.git",
  "publicLibrary": {
    "path": "/home/user/research-library"
  },
  "library": {
    "enabled": true,
    "remote": "https://github.com/mrshaun13/research-hub.git",
    "branch": "agent-contributions",
    "token": "<contributor PAT>",
    "gitUsername": "jdoe"
  },
  "projects": [
    {
      "slug": "espresso-machine-comparison",
      "title": "Home Espresso Machine Comparison",
      "subtitle": "Product Comparison Dashboard",
      "query": "I'm looking to buy an espresso machine for home use",
      "lens": "product",
      "icon": "Coffee",
      "accentColor": "amber",
      "createdAt": "2026-02-09T12:00:00Z",
      "updatedAt": "2026-02-09T14:00:00Z"
    }
  ]
}
```

### Fields

| Field | Type | Description |
|---|---|---|
| `version` | string | Config schema version |
| `created` | ISO 8601 | When the hub was first set up |
| `hubPath` | string | Absolute path to the hub directory |
| `port` | number | Vite dev server port (default: 5180) |
| `gitRepo` | string or null | Remote git URL for the user's personal hub repo. `null` if no remote configured. Set during Phase 0B. |
| `publicLibrary.path` | string or null | Path to read-only public library clone. `null` if user declined. Set during Phase 0B-LIBRARY. See [Public Library Browse](#public-library-browse). |
| `library.enabled` | boolean | Whether the user opted in to contributing. Once set, Phase 0C never asks again. |
| `library.remote` | string | URL of the public library repo |
| `library.branch` | string | Branch to push contributions to (always `agent-contributions`) |
| `library.token` | string | Fine-grained PAT for pushing. Provided by maintainer during one-time setup. **Never commit to any repo.** |
| `library.gitUsername` | string | From `git config user.name` — appended to slugs for collision avoidance. See [Community Library](#community-library). |
| `projects` | array | All registered research projects |
| `projects[].slug` | string | URL-safe directory name (kebab-case) |
| `projects[].title` | string | Display title for sidebar and cards |
| `projects[].subtitle` | string | Short description shown under title |
| `projects[].query` | string | The original user query that triggered this research |
| `projects[].lens` | string | Research lens: "standard", "product", "population", etc. |
| `projects[].icon` | string | Lucide icon name for sidebar display |
| `projects[].accentColor` | string | Tailwind color name for project theming (e.g., "cyan", "orange") |
| `projects[].createdAt` | ISO 8601 | When the project was first created |
| `projects[].updatedAt` | ISO 8601 | Last modification time |
| `projects[].telemetry` | object | Run telemetry and project statistics (see Telemetry Schema below) |

## Telemetry Schema

Every project tracks telemetry about its creation and the research run that produced it. This data is stored in `config.json` under each project's `telemetry` field and mirrored in `projects/index.js` for display in the hub UI.

### Example

```json
"telemetry": {
  "runStartedAt": "2026-02-09T12:00:00Z",
  "runCompletedAt": "2026-02-09T14:30:00Z",
  "durationMinutes": 150,
  "includedSetup": false,
  "skillVersion": "4.0",
  "userPrompt": "I'm looking to buy an espresso machine for home use",
  "researchPlan": "PRODUCT TYPE: Espresso Machine\nLIFECYCLE: Semi-Durable\n...",
  "checkpointModified": false,
  "model": "claude-sonnet-4-20250514",
  "tokenUsage": null,
  "searchesPerformed": 24,
  "sourcesCount": 18,
  "sectionsBuilt": 8,
  "chartsBuilt": 12,
  "filesGenerated": 14,
  "productsCompared": 18,
  "dataPointsCollected": 216,
  "phaseTiming": {
    "environment": 2,
    "interpret": 5,
    "survey": 15,
    "discover": 20,
    "research": 45,
    "analyze": 10,
    "build": 40,
    "present": 13
  }
}
```

### Telemetry Fields

| Field | Type | Required | Description |
|---|---|---|---|
| `runStartedAt` | ISO 8601 | ✓ | Timestamp when the skill invocation began (Phase 0 start) |
| `runCompletedAt` | ISO 8601 | ✓ | Timestamp when Phase 7 finished |
| `durationMinutes` | number | ✓ | Total wall-clock minutes from start to finish |
| `includedSetup` | boolean | ✓ | Whether Phase 0B (first-time hub setup) was part of this run |
| `skillVersion` | string | ✓ | Version from SKILL.md frontmatter (e.g., "4.0") |
| `userPrompt` | string | ✓ | The exact original prompt the user provided to trigger the skill |
| `researchPlan` | string | ✓ | The full research plan text presented at the Phase 3D checkpoint |
| `checkpointModified` | boolean | ✓ | Whether the user requested changes at the checkpoint |
| `model` | string | optional | LLM model identifier (e.g., "claude-sonnet-4-20250514", "gpt-4o") |
| `tokenUsage` | number\|null | optional | Approximate total tokens consumed during the run, null if unavailable |
| `searchesPerformed` | number | ✓ | Total web searches executed across all phases |
| `sourcesCount` | number | ✓ | Number of unique sources cited in the final dashboard |
| `sectionsBuilt` | number | ✓ | Number of dashboard sections created |
| `chartsBuilt` | number | ✓ | Number of individual chart/visualization components |
| `filesGenerated` | number | ✓ | Total files written to the project directory |
| `productsCompared` | number\|null | optional | Number of products in comparison (Product lens only, null otherwise) |
| `dataPointsCollected` | number | ✓ | Approximate count of individual data points gathered during research |
| `phaseTiming` | object | ✓ | Per-phase duration in minutes |
| `phaseTiming.environment` | number | | Minutes spent in Phase 0 |
| `phaseTiming.interpret` | number | | Minutes spent in Phase 1 |
| `phaseTiming.survey` | number | | Minutes spent in Phase 2 |
| `phaseTiming.discover` | number | | Minutes spent in Phase 3 |
| `phaseTiming.research` | number | | Minutes spent in Phase 4 |
| `phaseTiming.analyze` | number | | Minutes spent in Phase 5 |
| `phaseTiming.build` | number | | Minutes spent in Phase 6 |
| `phaseTiming.present` | number | | Minutes spent in Phase 7 |

### Content Analysis (Readability & Cognitive Depth)

Captured in Phase 7 by analyzing all text content in the dashboard (insight callouts, section descriptions, data labels, tooltip text, recommendation text).

```json
"contentAnalysis": {
  "fleschKincaidGrade": 10.2,
  "fleschKincaidLabel": "10th Grade",
  "bloomsLevel": 4,
  "bloomsLabel": "Analyze",
  "bloomsRange": "Understand → Evaluate",
  "totalWords": 4500,
  "totalSentences": 225,
  "readabilityNote": "College-prep level with data-driven analytical content"
}
```

| Field | Type | Description |
|---|---|---|
| `fleschKincaidGrade` | number | Flesch-Kincaid grade level. Formula: `0.39 × (words/sentences) + 11.8 × (syllables/words) − 15.59` |
| `fleschKincaidLabel` | string | Human-readable label (e.g., "10th Grade", "College", "7th Grade") |
| `bloomsLevel` | number | Dominant Bloom's Taxonomy level (1-6): 1=Remember, 2=Understand, 3=Apply, 4=Analyze, 5=Evaluate, 6=Create |
| `bloomsLabel` | string | Label for the dominant level |
| `bloomsRange` | string | Range of cognitive levels present (e.g., "Understand → Evaluate") |
| `totalWords` | number | Total word count across all dashboard text content |
| `totalSentences` | number | Total sentence count |
| `readabilityNote` | string | Brief characterization of the content's reading experience |

**Bloom's Level Assessment Guide:**
- **Data tables, raw stats, timelines** → Remember (1) / Understand (2)
- **Comparative charts, trend analysis** → Analyze (4)
- **Insight callouts with "why" explanations** → Analyze (4)
- **Recommendations, decision frameworks, verdicts** → Evaluate (5)
- **Interactive filtering that reveals patterns** → Apply (3) / Analyze (4)
- Assign the level that covers >50% of the dashboard's content. Note the full range.

### Hours Saved Estimation

Estimates the equivalent manual effort a human would need to produce the same research and output. Calculated in Phase 7 based on build metrics.

```json
"hoursSaved": {
  "researchHours": 18.5,
  "productionHours": {
    "interactive-dashboard": 62,
    "white-paper": 35,
    "blog-post": 22,
    "technical-doc": 28,
    "presentation": 15,
    "github-repo": 38
  },
  "totalHoursSaved": 80.5,
  "equivalentLabel": "~2 weeks full-time"
}
```

| Field | Type | Description |
|---|---|---|
| `researchHours` | number | Estimated hours a human would spend on research alone |
| `productionHours` | object | Estimated production hours by output format |
| `productionHours.interactive-dashboard` | number | Hours to hand-build the equivalent React dashboard |
| `productionHours.white-paper` | number | Hours to write an equivalent white paper |
| `productionHours.blog-post` | number | Hours to write an equivalent blog post series |
| `productionHours.technical-doc` | number | Hours to write an equivalent RFC/technical document |
| `productionHours.presentation` | number | Hours to create an equivalent slide deck |
| `productionHours.github-repo` | number | Hours to build an equivalent documented repo |
| `totalHoursSaved` | number | `researchHours + productionHours['interactive-dashboard']` |
| `equivalentLabel` | string | Human-readable equivalent (e.g., "~2 weeks full-time", "~1 week full-time") |

**Estimation Formulas:**
```
researchHours = (sourcesCount × 0.75) + (dataPointsCollected × 0.02) + (searchesPerformed × 0.25)

productionHours['interactive-dashboard'] = (sectionsBuilt × 6) + (chartsBuilt × 3) + (filesGenerated × 0.5)
productionHours['white-paper']           = (sectionsBuilt × 4) + (sourcesCount × 0.5) + (dataPointsCollected × 0.01)
productionHours['blog-post']             = (sectionsBuilt × 2.5) + (chartsBuilt × 1)
productionHours['technical-doc']         = (sectionsBuilt × 3) + (sourcesCount × 0.3)
productionHours['presentation']          = (sectionsBuilt × 1.5) + (chartsBuilt × 0.5)
productionHours['github-repo']           = (sectionsBuilt × 3) + (chartsBuilt × 2) + (filesGenerated × 0.5)

totalHoursSaved = researchHours + productionHours['interactive-dashboard']
equivalentLabel = totalHoursSaved < 20 ? "~X days" : "~Y weeks full-time"
```

### Consumption Time

Estimates how long a human reader (matching the Flesch-Kincaid level) would need to fully consume the dashboard content.

```json
"consumptionTime": {
  "estimatedMinutes": 45,
  "readingMinutes": 30,
  "chartExplorationMinutes": 10.5,
  "interactiveOverheadMinutes": 4.5,
  "estimatedLabel": "~45 min deep read"
}
```

| Field | Type | Description |
|---|---|---|
| `estimatedMinutes` | number | Total estimated consumption time in minutes |
| `readingMinutes` | number | Time to read all text content |
| `chartExplorationMinutes` | number | Time to meaningfully interpret all charts |
| `interactiveOverheadMinutes` | number | Additional time for interactive exploration (filtering, drilling down) |
| `estimatedLabel` | string | Human-readable label (e.g., "~45 min deep read", "~1.5 hr deep read") |

**Estimation Formulas:**
```
readingWPM = fleschKincaidGrade > 12 ? 120 : 150   // slower for college+ level
readingMinutes = totalWords / readingWPM
chartExplorationMinutes = chartsBuilt × 0.75        // ~45 seconds per chart
interactiveOverheadMinutes = (readingMinutes + chartExplorationMinutes) × 0.2
estimatedMinutes = readingMinutes + chartExplorationMinutes + interactiveOverheadMinutes
```

### When to Capture

| Data Point | Capture Moment |
|---|---|
| `runStartedAt` | Phase 0 — immediately when skill begins |
| `includedSetup` | Phase 0 — set to true if Phase 0B runs |
| `skillVersion` | Phase 0 — read from SKILL.md frontmatter |
| `userPrompt` | Phase 1 — the raw user input before interpretation |
| `researchPlan` | Phase 3D — the full checkpoint text shown to the user |
| `checkpointModified` | Phase 3D — whether user requested adjustments |
| `model` | Phase 0 — note the current model if detectable |
| `searchesPerformed` | Phases 2-4 — increment counter with each web search |
| `sourcesCount` | Phase 6 — count unique sources in the data files |
| `sectionsBuilt`, `chartsBuilt`, `filesGenerated` | Phase 6 — count after build completes |
| `productsCompared` | Phase 6 — count products array length (Product lens) |
| `dataPointsCollected` | Phase 4 — count data points gathered |
| `phaseTiming.*` | Each phase — note start/end timestamps, calculate delta |
| `contentAnalysis.*` | Phase 7 — analyze all text in built components |
| `hoursSaved.*` | Phase 7 — calculate from build metrics using formulas above |
| `consumptionTime.*` | Phase 7 — calculate from word count + chart count + FK grade |
| `runCompletedAt`, `durationMinutes` | Phase 7 — final timestamp and total calculation |
| `tokenUsage` | Phase 7 — if available from the runtime environment |

## Hub Directory Structure

```
<hubPath>/                              (e.g., ~/research-hub/)
├── package.json
├── vite.config.js
├── tailwind.config.js
├── postcss.config.js
├── index.html
└── src/
    ├── main.jsx
    ├── index.css
    ├── App.jsx                          ← Hub shell: collapsible sidebar + project routing
    ├── components/
    │   └── HubHome.jsx                  ← Landing page with project cards grid
    └── projects/
        ├── index.js                     ← Project registry: imports + metadata exports
        ├── cisco-history-dashboard/
        │   ├── App.jsx                  ← Original project App (unchanged)
        │   ├── components/
        │   │   ├── Overview.jsx
        │   │   └── ...
        │   └── data/
        │       └── ciscoData.js
        └── espresso-machine-comparison/
            ├── App.jsx
            ├── components/
            │   ├── Overview.jsx
            │   └── ...
            └── data/
                ├── products.js
                └── productDetails.js
```

## Project Registry (src/projects/index.js)

This file is the bridge between the hub shell and individual projects. It exports:
1. `projectRegistry` — array of metadata objects (title, slug, icon, etc.)
2. `projectComponents` — map of slug → lazy-loaded React component

```javascript
import { lazy } from 'react';

export const projectRegistry = [
  {
    slug: 'cisco-history-dashboard',
    title: 'Cisco History Dashboard',
    subtitle: '40 Years of Innovation',
    query: 'Research the history of Cisco Systems...',
    lens: 'standard',
    icon: 'Building2',
    accentColor: 'cyan',
    createdAt: '2026-02-08T12:00:00Z',
  },
  {
    slug: 'espresso-machine-comparison',
    title: 'Home Espresso Machine Comparison',
    subtitle: 'Product Comparison Dashboard',
    query: "I'm looking to buy an espresso machine for home use",
    lens: 'product',
    icon: 'Coffee',
    accentColor: 'amber',
    createdAt: '2026-02-09T12:00:00Z',
  },
];

export const projectComponents = {
  'cisco-history-dashboard': lazy(() => import('./cisco-history-dashboard/App')),
  'espresso-machine-comparison': lazy(() => import('./espresso-machine-comparison/App')),
};
```

**When adding a new project**, the skill:
1. Creates the project directory under `src/projects/<slug>/`
2. Adds an import line and registry entry to `src/projects/index.js`
3. Adds the project to `config.json`

## Hub App Shell Design

The hub uses a **ChatGPT-style layout** with optional public library integration:

### Sidebar (collapsible)
- **Header**: "Research Hub" branding with a collapse toggle
- **My Research** section: Each project shows icon + title + date, sorted newest-first
- **Active indicator**: Highlighted item for currently viewed project
- **Home / Library button** (far left/top): Returns to the hub landing page which includes the public library browser if configured
- Sidebar collapses to icon-only mode; expands on hover or click
- Sidebar search filters **local projects only**

### Main Content Area
- **Home view** (no project selected): Two areas:
  - **My Research**: Grid of local project cards (title, subtitle, lens badge, date, accent color border)
  - **Public Library** (if `publicLibrary.path` is set): Grid of community project cards, badged as "Community", showing contributor username. Separate search bar for filtering public projects.
- **Project view** (project selected): Renders the project's App component full-width. Public library projects render read-only with a "Community" banner.

### Responsive
- On mobile: sidebar is a slide-out drawer with overlay
- On desktop: sidebar is persistent, collapsible

## Adding a New Project (Skill Workflow)

When the skill runs Phase 6 (BUILD) and the hub already exists:

1. **Create project directory**: `<hubPath>/src/projects/<slug>/`
2. **Write all project files** (App.jsx, components/, data/) into that directory — same structure as before, just nested under the hub
3. **Update registry**: Add import + metadata entry to `src/projects/index.js`
4. **Update config**: Add project entry to `config.json`
5. **Skip npm install** if no new dependencies (the hub already has React, Recharts, Tailwind, Lucide)
6. **Tell user to refresh browser** — Vite HMR will pick up new files automatically if dev server is running; if not, start it

## First-Time Setup Flow

When the skill detects no `config.json`:

1. **Inform user**: "I see this is your first time running Research Visualizer. I need to set up a Research Hub — a single web app that will host all your research dashboards."
2. **Ask for location**: "Where would you like to install the Research Hub? Default: `~/research-hub/`"
3. **Scaffold hub**: Create all hub files using the exact templates from [hub-scaffold-templates.md](hub-scaffold-templates.md) (package.json, vite config, App.jsx with two-section sidebar, HubHome with dual browsable areas, etc.)
4. **Run npm install**
5. **Create config.json** with hubPath and empty projects array
6. **Continue with the user's research request** (Phases 1-7 as normal, building into the hub)

## Git Sync — Cross-Machine Portability

The Research Hub is designed to be backed by a git repo, allowing research to be created on one machine and consumed on another without re-running any agent tasks.

### What's in the repo vs machine-local

| Item | In Git Repo | Why |
|---|---|---|
| `src/projects/` (all project dirs + index.js) | ✅ | All research data, components, and registry |
| `src/App.jsx`, `src/components/`, `src/main.jsx`, `src/index.css` | ✅ | Hub shell — needed to run |
| `package.json`, `package-lock.json` | ✅ | Dependency definitions |
| `vite.config.js`, `tailwind.config.js`, `postcss.config.js`, `index.html` | ✅ | Build/run config |
| `.gitignore` | ✅ | Excludes node_modules, dist |
| `node_modules/` | ❌ | Regenerated by `npm install` |
| `dist/` | ❌ | Build output, regenerated by `npm run build` |
| `config.json` (at `~/.codeium/windsurf/skills/research-visualizer/`) | ❌ | **Machine-local** — contains `hubPath` which differs per machine |

### Config Schema (with git fields)

```json
{
  "version": "1.0",
  "created": "2026-02-10T07:00:00Z",
  "hubPath": "/home/user/research-hub",
  "port": 5180,
  "gitRepo": "git@github.com:user/research-hub.git",
  "projects": [...]
}
```

The `gitRepo` field is optional. If set, the skill knows to pull on startup and push after builds.

### Sync Workflow

**On startup (Phase 0 Detection):**
1. Config exists → read `hubPath`
2. Hub directory has `.git` with a remote → `git pull` (stash/pop if needed)
3. Note any new projects pulled in

**After build (Phase 7):**
1. Hub directory has `.git` with a remote → `git add -A && git commit && git push`
2. Inform user their research is synced

**New machine setup (Phase 0B-CLONE):**
1. User provides repo URL → `git clone <url> <path>`
2. `npm install`
3. Create local `config.json` pointing to clone path
4. All previous research is immediately available

### .gitignore

```
node_modules/
dist/
.DS_Store
*.local
```

## Public Library Browse

Users can browse the **public Research Library** — a read-only clone of the community's shared research dashboards. This requires no authentication (public repo) and is separate from contributing.

### Setup (Phase 0B-LIBRARY)

During first-time setup, the user is asked if they want to browse the public library. If yes:

```bash
git clone https://github.com/mrshaun13/research-hub.git <hubPath>/../research-library
```

### Config Schema (publicLibrary fields)

```json
"publicLibrary": {
  "path": "/home/user/research-library"
}
```

| Field | Type | Description |
|---|---|---|
| `publicLibrary.path` | string or null | Path to the read-only public library clone. `null` if user declined. |

### Sync

On each skill invocation (Phase 0 Detection), if `publicLibrary.path` is set:
```bash
git -C <publicLibrary.path> pull
```
This fetches the latest community research. No push ever happens to this clone.

### Hub UI Integration

When the public library is available, the hub displays content in **two places**:

**Sidebar (collapsible, two sections):**
1. **Personal Research** — section header with sparkle icon, independent search bar, lists user's own projects
2. **Shared Research** — section header with library icon, independent search bar, lists public library projects. Only visible when `publicLibrary.path` is configured and has projects. Separated by a subtle border.

**Main content (HubHome landing page):**
1. **My Research** — card grid of personal projects (or empty state prompt)
2. **Public Library** — card grid of community projects with search, shown only when library is configured

**Navigation:**
- Clicking the **Research Hub logo/title** in the sidebar header returns to the home landing page
- When viewing a project, a **back button bar** appears at the top of the main content area with `← Back | Project Title` and a "Community — read-only" badge for shared projects
- Clicking any project in either sidebar section switches directly to that project

The hub reads the public library's `src/projects/index.js` via the `@public-library` Vite alias to discover available projects and renders them as read-only cards. See [hub-scaffold-templates.md](hub-scaffold-templates.md) for the exact App.jsx and HubHome.jsx implementations.

**Key differences from local projects:**
- Public projects are read-only — no editing, no data changes
- Public projects show the contributor's username (from the slug suffix)
- Public projects have a "Community" badge on their cards and in the back bar
- Search is split: sidebar has independent search per section, HubHome has a library search bar

### Directory Layout

```
~/research-hub/          ← user's own hub (read-write)
~/research-library/      ← public library clone (read-only)
```

These are completely separate git repos. The hub app reads from both at runtime.

### Public Library Vite Alias

The personal hub imports the public library's project registry using a **Vite resolve alias**. This is configured during Phase 0B-LIBRARY.

**vite.config.js** (after library setup):
```js
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  server: {
    port: 5180,
    host: true,
  },
  resolve: {
    alias: {
      '@public-library': path.resolve('<publicLibrary.path>', 'src'),
    },
  },
});
```

**How the hub uses it:**

In `App.jsx`, conditionally import the public library's registry:
```js
// Try to import public library projects — fails gracefully if not configured
let publicProjectRegistry = [];
let publicProjectComponents = {};
try {
  const publicLib = await import('@public-library/projects');
  publicProjectRegistry = publicLib.projectRegistry || [];
  publicProjectComponents = publicLib.projectComponents || {};
} catch (e) {
  // Public library not configured or not available — that's fine
}
```

In practice, since static imports are simpler for Vite bundling, the scaffold should use a **static import with a try/catch wrapper** or a **dynamic import in a useEffect**. The key requirement: if the alias doesn't resolve (no library configured), the hub must still load without errors — it just shows the "My Research" section only.

**When scaffolding App.jsx and HubHome.jsx during Phase 0B-SCAFFOLD:**
- Always include the public library import logic and the two-area HubHome layout
- When no public library is configured, the Public Library section simply doesn't render (empty array, hidden section)
- When the library IS configured (Phase 0B-LIBRARY adds the alias), the import resolves and public projects appear automatically

**When Phase 0B-LIBRARY runs:**
1. Clone the public library repo
2. Add the `@public-library` alias to `vite.config.js`
3. Run `npm install` in the public library directory if needed
4. The hub's existing App.jsx/HubHome.jsx will now automatically pick up the public library projects on next dev server restart

---

## Community Library

The Research Hub supports an optional community **contribution** model. Users can share their completed research dashboards to the public library, helping others learn and improving the skill through diverse research examples. This is separate from browsing — contributing requires a PAT.

### Architecture

```
┌─────────────────────┐     git push              ┌──────────────────────┐
│  User's Own Hub     │ ──────────────────────►   │  User's Own Repo     │
│  ~/research-hub/    │     (personal remote)     │  (their GitHub)      │
│                     │                           └──────────────────────┘
│                     │     GitHub API
│                     │  (blobs → tree → commit   ┌──────────────────────┐
│                     │   → update ref)           │  Public Library      │
│                     │ ──────────────────────►   │  mrshaun13/          │
│                     │     PAT auth              │  research-hub        │
└─────────────────────┘                           │  (agent-contributions│
                                                  │   branch)            │
                                                  └──────────┬───────────┘
                                                             │ push triggers
                                                  ┌──────────▼───────────┐
                                                  │  GitHub Action       │
                                                  │  • Detect projects   │
                                                  │  • Validate structure│
                                                  │  • Build test        │
                                                  │  • Auto-merge → main│
                                                  │  (or Issue on fail)  │
                                                  └──────────────────────┘
```

**Key design decision:** The personal hub and public library are **completely separate git repositories** with independent histories. Contributions cannot use `git push` across repos. Instead, the agent uses the **GitHub REST API** (Git Data endpoints) to create blobs, trees, and commits directly on the library's `agent-contributions` branch. This works with any PAT that has `Contents: write` permission — no local clone of the library is needed.

### Config Schema (library fields)

Added to the machine-local `config.json`:

```json
{
  "version": "1.0",
  "hubPath": "/home/user/research-hub",
  "port": 5180,
  "gitRepo": "git@github.com:user/their-hub.git",
  "library": {
    "enabled": true,
    "remote": "https://github.com/mrshaun13/research-hub.git",
    "branch": "agent-contributions",
    "token": "<contributor PAT>",
    "gitUsername": "jdoe"
  },
  "projects": [...]
}
```

| Field | Type | Description |
|---|---|---|
| `library.enabled` | boolean | Whether the user has opted in to sharing. Once set, Phase 0C never asks again. |
| `library.remote` | string | URL of the public library repo (used to derive the API base URL) |
| `library.branch` | string | Branch to push contributions to (always `agent-contributions`) |
| `library.token` | string | Fine-grained PAT for pushing to the library. Provided by the maintainer during one-time setup. Stored locally in config.json (never committed to any repo). |
| `library.gitUsername` | string | From `git config user.name` — appended to project slugs to avoid collisions (e.g., `chainsaw-comparison-jdoe`) |

### Slug Collision Avoidance

When library sharing is enabled, project slugs are suffixed with the contributor's `gitUsername`:
- Local slug: `chainsaw-comparison`
- Library slug: `chainsaw-comparison-jdoe`

This ensures multiple contributors can research the same topic without overwriting each other's projects in the library.

### Agent-Side Setup (Phase 0C)

When the user opts in during Phase 0C and provides a PAT:

1. Store the PAT and username in `config.json` under the `library` field (see schema above)
2. **No git remote is needed.** Contributions use the GitHub API directly.
3. The PAT is used as an `Authorization: token <PAT>` header on all API calls.

### Agent-Side Contribution Flow (Phase 7 Step 8)

When `library.enabled` is true, the agent shares the project via the GitHub REST API:

1. **Determine library slug:** `<local-slug>-<gitUsername>` (e.g., `pixel-upgrade-analysis-mrshaun13`)

2. **Get branch HEAD:**
   ```
   GET /repos/mrshaun13/research-hub/git/ref/heads/agent-contributions
   ```
   Extract the commit SHA, then get the tree SHA from that commit.

3. **Read the library's current `index.js`:**
   ```
   GET /repos/mrshaun13/research-hub/contents/src/projects/index.js?ref=agent-contributions
   ```
   Decode the base64 content. Add the new project's registry entry (with full telemetry) to the `projectRegistry` array and add the lazy component import to `projectComponents`.

4. **Create blobs** for each project file and the updated `index.js`:
   ```
   POST /repos/mrshaun13/research-hub/git/blobs
   { "content": "<file content>", "encoding": "utf-8" }
   ```
   Files to push: `App.jsx`, all `components/*.jsx`, all `data/*.js`, and the updated `index.js`.

5. **Create tree** with all blob entries:
   ```
   POST /repos/mrshaun13/research-hub/git/trees
   {
     "base_tree": "<tree SHA from step 2>",
     "tree": [
       { "path": "src/projects/<library-slug>/App.jsx", "mode": "100644", "type": "blob", "sha": "<blob SHA>" },
       { "path": "src/projects/<library-slug>/components/Overview.jsx", ... },
       { "path": "src/projects/index.js", "mode": "100644", "type": "blob", "sha": "<updated index blob>" }
     ]
   }
   ```

6. **Create commit:**
   ```
   POST /repos/mrshaun13/research-hub/git/commits
   {
     "message": "Add <project title> (contributor: <gitUsername>)",
     "tree": "<new tree SHA>",
     "parents": ["<branch HEAD SHA from step 2>"]
   }
   ```

7. **Update ref** to point `agent-contributions` to the new commit:
   ```
   PATCH /repos/mrshaun13/research-hub/git/refs/heads/agent-contributions
   { "sha": "<new commit SHA>" }
   ```

8. **Inform the user:** "Your research has been shared with the public library. A validation workflow will run automatically — if it passes, your research will be merged to main without any manual steps."

All API calls use `Authorization: token <library.token>` header. If any call returns 401/403, inform the user the PAT may be invalid or expired.

### Automated Validation & Merge (Server-Side)

When a push lands on `agent-contributions`, a GitHub Action (`.github/workflows/process-contributions.yml`) runs automatically:

1. **Detect new projects** — compares `agent-contributions` against `main` to find new `App.jsx` files
2. **Validate project structure** — runs `.github/scripts/validate-research-project.mjs` which checks:
   - File structure: `App.jsx`, `components/` (with Overview.jsx + Sources.jsx minimum), `data/` with substantial files
   - Registry entry: all required fields present, valid lens, valid slug format, ISO timestamps
   - Telemetry: all required fields, sane ranges, phase timing, content analysis, hours saved, consumption time
   - Content quality: React imports, JSX patterns, chart/visualization usage, data exports
   - Product lens extras: `productsCompared >= 3` for product lens projects
3. **Build test** — runs `npm ci && vite build` to verify no compilation errors
4. **If ALL pass** → auto-merges `agent-contributions` into `main` via the GitHub API merge endpoint (authenticated with `ADMIN_PAT` repo secret)
5. **If ANY fail** → creates a GitHub Issue with the full validation report, tagged `validation-failed`

### Security Model

| Layer | Protection |
|---|---|
| **Contributor PAT** | Fine-grained, scoped to `mrshaun13/research-hub` only, `Contents: write` permission. Can only push to `agent-contributions` (branch protection blocks `main`). |
| **Branch protection on `main`** | Repository ruleset requires PRs for changes. Only the repo admin (SSH) and the `ADMIN_PAT` (stored as a GitHub secret) can write to `main`. |
| **Validation script** | Lives on `main` — contributors cannot modify it. Runs server-side on GitHub's infrastructure. Checks structure, telemetry, content quality, and build integrity. |
| **Auto-merge** | Uses `ADMIN_PAT` (repo secret, invisible to contributors) via the GitHub API merge endpoint. Only executes after all validation checks pass. |
| **Failure notification** | Failed contributions create a GitHub Issue with details — visible to both the repo owner and the contributor. |

### Maintainer-Side Setup

The library maintainer (repo owner) needs to configure:

1. **Branch protection on `main`:**
   - Repository ruleset requiring pull requests for changes
   - Repository admin in the bypass list
   - `ADMIN_PAT` stored as a repo secret (Settings → Secrets → Actions) — this PAT must have `Contents: write` and belong to a repo admin

2. **GitHub Action** (`.github/workflows/process-contributions.yml`):
   - Already configured — triggers on push to `agent-contributions`
   - Validates, builds, and auto-merges on success

3. **Validation script** (`.github/scripts/validate-research-project.mjs`):
   - Already configured — comprehensive checks for structure, metadata, telemetry, and content quality

4. **Scoped PAT for contributors:**
   - Create a fine-grained PAT with:
     - Repository access: `mrshaun13/research-hub` only
     - Permissions: Contents (write)
   - Branch protection ensures this PAT can only write to `agent-contributions`
   - Distribute to users who opt in

### Zero-Effort Sharing

Users who don't have their own git repo can still share:
- The agent uses the GitHub API directly — no local clone of the library is needed
- After a build, the agent pushes project files via the API
- The user doesn't need to understand git — the agent handles everything

### Ad-Hoc Sharing

Users can share past research at any time by asking the skill:
> "Share my chainsaw comparison with the public library"

The skill will:
1. Read the project files from the user's local hub
2. Push them to `agent-contributions` via the GitHub API (same flow as Phase 7 step 8)
3. Confirm to the user: "Shared! The validation workflow will run automatically."

## Port Management

The hub always runs on a fixed port (default: 5180) configured in:
- `config.json` → `port` field
- `vite.config.js` → `server.port`

This avoids port conflicts from multiple dev servers. Only ONE server ever runs.

## Edge Cases & Troubleshooting

| Situation | How to Handle |
|---|---|
| Topic is too broad (e.g., "research everything about health") | Ask user to narrow: "What aspect of health? Which population?" |
| No academic data exists for a dimension | Note as data-limited, use T3/T4 sources, caveat clearly in dashboard |
| Subgroup discovery finds >5 meaningful splits | Keep top 3-4 most distinct, merge rest into "other" |
| Taxonomy discovery returns <10 items | Expand search to adjacent fields, accept smaller taxonomy |
| User checkpoint gets major revisions | Re-run Phase 3 discovery for new dimensions, don't restart from scratch |
| File writing fails (write_to_file doesn't persist) | Fall back to shell heredoc commands, verify with `ls -la` |
| Build fails with import errors | Check all exports match imports, verify data file schemas |
| Charts render but show wrong data | Spot-check: compare 2-3 data points in chart vs source data file |
| Product lens: too many products to compare (>25) | Narrow to top 15-20 by eliminating discontinued, unavailable, or redundant models |
| Product lens: can't find purchase links for a product | Use manufacturer URL + generic retailer search URL; note "check availability" |
| Product lens: conflicting specs across sources | Prefer manufacturer specs > independent testing > retailer listings; note discrepancies |
| Product lens: user's product category is ambiguous | Ask: "Are you looking for [interpretation A] or [interpretation B]?" before proceeding |
| Product lens: no clear market tiers exist | Use price-based segmentation (Budget/Mid/Premium) or skip tier system entirely |
| Product lens: product is too niche (<5 options exist) | Include all available options; supplement with adjacent products or previous-gen models |
| Hub: config.json exists but hubPath directory is missing | Re-run first-time setup (Phase 0B), preserve existing project entries from config |
| Hub: dev server already running on the port | Skip starting a new server; tell user to refresh browser |
| Hub: project slug already exists in registry | Ask user: overwrite existing project or choose a new name? |
| Hub: npm install fails in hub directory | Check node/npm versions, clear node_modules and retry, check for lockfile conflicts |
| Hub: new project doesn't appear after refresh | Verify projects/index.js was updated correctly, check for import errors in browser console |
| Git: push fails with authentication error | Verify SSH keys or HTTPS credentials are configured for the remote |
| Git: pull has merge conflicts | Conflicts likely in `src/projects/index.js` — resolve by keeping both project entries, then re-commit |
| Git: config.json has wrong hubPath after clone | config.json is machine-local (not in repo) — just update the `hubPath` field to match the local clone path |
| Git: user wants to add remote to existing hub later | `cd <hubPath> && git remote add origin <url> && git push -u origin main` — then update config.json `gitRepo` field |
| Library: user wants to opt in after initially declining | Update config.json `library.enabled` to true, store PAT and gitUsername. No git remote needed. |
| Library: GitHub API call fails with 401/403 | The library PAT is missing, expired, or lacks `Contents: write` permission — ask user to contact the library maintainer for a new scoped PAT |
| Library: GitHub API call fails with 409 (conflict) | Another contribution may be in progress. Wait a moment and retry. If persistent, the `agent-contributions` branch may have diverged — get the latest HEAD and retry. |
| Library: user asks to "share with the public library" | Run the library share flow from Phase 7 step 8, even outside of a normal research run |
| Library: slug collision in the library | Slugs are suffixed with `gitUsername` (e.g., `chainsaw-comparison-jdoe`) — collisions should not occur |
| Library: validation workflow fails after push | A GitHub Issue is created automatically with failure details. Fix the issues in the local project and re-push. |
| Library: project already exists in library index.js | When reading the current index.js (step 3 of contribution flow), check if the slug already exists. If so, update the existing entry rather than adding a duplicate. |
