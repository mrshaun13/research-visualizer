# Research Hub Architecture

The Research Hub is a single web application that hosts all research projects generated by the research-visualizer skill. Instead of scaffolding a new standalone Vite project for each research topic, all projects live under one hub with a unified navigation experience.

## Config Architecture (Two-Layer)

The skill uses a **two-layer config** to make the entire setup portable across machines. The personal hub repo is the portable unit — clone it on a new machine, point the skill at it, and everything works.

### Layer 1: Pointer Config (Machine-Local)

**Location:** `~/.codeium/windsurf/skills/research-visualizer/config.json`

This file is the **installation detection marker**. If it exists, the hub has been set up on this machine. Contains ONLY the path to the personal hub — never committed to any repo.

```json
{
  "personalHubPath": "/home/user/git/personal-research-hub"
}
```

| Field | Type | Description |
|---|---|---|
| `personalHubPath` | string | Absolute path to the user's personal hub repo on this machine |

### Layer 2: Portable Config (Git-Synced)

**Location:** `<personalHubPath>/hub-config.json`

Contains everything else: port, gitRepo, libraries, projects, telemetry. Committed to the personal hub repo — syncs across machines automatically via git.

```json
{
  "version": "3.0",
  "created": "2026-02-10T21:00:00Z",
  "port": 5180,
  "gitRepo": "git@github.com:user/personal-research-hub.git",
  "libraries": [
    {
      "name": "Community Research Hub",
      "remote": "https://github.com/mrshaun13/research-hub.git",
      "branch": "agent-contributions",
      "token": "<contributor PAT>",
      "gitUsername": "jdoe",
      "browseEnabled": true,
      "contributeEnabled": true,
      "confirmEachShare": false,
      "role": "contributor"
    }
  ],
  "projects": [
    {
      "slug": "espresso-machine-comparison",
      "title": "Home Espresso Machine Comparison",
      "subtitle": "Product Comparison Dashboard",
      "query": "I'm looking to buy an espresso machine for home use",
      "lens": "product",
      "icon": "Coffee",
      "accentColor": "amber",
      "visibility": "personal",
      "createdAt": "2026-02-09T12:00:00Z"
    }
  ],
  "collections": [
    {
      "extensionSlug": "incident-review",
      "collectionName": "Incident Reviews",
      "icon": "AlertTriangle",
      "accentColor": "red",
      "itemCount": 347,
      "installedAt": "2026-02-10T14:00:00Z",
      "lastUpdated": "2026-02-12T16:12:00Z",
      "visibility": "personal"
    }
  ]
}
```

### Portable Config Fields

| Field | Type | Description |
|---|---|---|
| `version` | string | Config schema version (current: "3.0") |
| `created` | ISO 8601 | When the hub was first set up |
| `port` | number | Vite dev server port (default: 5180) |
| `gitRepo` | string or null | Remote git URL for the user's personal hub repo. `null` if no remote configured. |
| `libraries` | array | Configured shared research libraries (can be empty). See [Libraries](#libraries-array). |
| `projects` | array | All registered research projects |
| `projects[].slug` | string | URL-safe directory name (kebab-case) |
| `projects[].title` | string | Display title for sidebar and cards |
| `projects[].subtitle` | string | Short description shown under title |
| `projects[].query` | string | The original user query that triggered this research |
| `projects[].lens` | string | Research lens: "standard", "product", "population", etc. |
| `projects[].icon` | string | Lucide icon name for sidebar display |
| `projects[].accentColor` | string | Tailwind color name for project theming (e.g., "cyan", "orange") |
| `projects[].createdAt` | ISO 8601 | When the project was first created |
| `projects[].updatedAt` | ISO 8601 | Last modification time |
| `projects[].visibility` | string | Project visibility tier: `"local"`, `"personal"` (default), or `"public"`. Controls where files live and how they sync. See [hub-visibility.md](hub-visibility.md). Note: local projects are stored in `.local-config.json` instead, not here. |
| `collections` | array | Registered template-mode collections (can be empty). See [collections-architecture.md](collections-architecture.md). |
| `collections[].extensionSlug` | string | Extension slug and directory name under `src/collections/` |
| `collections[].collectionName` | string | Display name for the collection |
| `collections[].icon` | string | Lucide icon name |
| `collections[].accentColor` | string | Tailwind color name |
| `collections[].itemCount` | number | Current number of items |
| `collections[].installedAt` | ISO 8601 | When the collection was first set up |
| `collections[].lastUpdated` | ISO 8601 | When the last item was added or updated |
| `collections[].visibility` | string | Same three tiers as projects |

**Note:** Project telemetry is NOT stored in `hub-config.json` or `projects/index.js`. Telemetry lives in per-project `meta.json` files and is lazy-loaded by the hub UI on demand. See [Telemetry Schema](#telemetry-schema).

### Libraries Array

Each entry in the `libraries` array represents a shared research library. Multiple libraries can be configured (e.g., a team library + the public community library).

| Field | Type | Description |
|---|---|---|
| `libraries[].name` | string | Display name for the library (e.g., "Community Research Hub") |
| `libraries[].remote` | string | Git URL of the library repo |
| `libraries[].branch` | string | Branch to push contributions to (e.g., `agent-contributions`) |
| `libraries[].token` | string or null | Fine-grained PAT for contributing. `null` if browse-only. |
| `libraries[].gitUsername` | string or null | From `git config user.name` — appended to slugs for collision avoidance. `null` if browse-only. |
| `libraries[].browseEnabled` | boolean | Whether the user can browse this library's projects |
| `libraries[].contributeEnabled` | boolean | Whether the agent should push completed research to this library |
| `libraries[].confirmEachShare` | boolean | If true, ask before each contribution. If false, auto-share. |
| `libraries[].role` | string | `"maintainer"` or `"contributor"` — affects UI badges and permissions |

### Layer 3: Machine-Local Vite Config (Gitignored)

**Location:** `<personalHubPath>/.local-config.json`

Contains machine-specific library paths for Vite aliases. Created by the skill during Phase 0 setup. Read by `vite.config.js` at dev server startup. Gitignored (`.local-config.json` in `.gitignore`).

```json
{
  "libraries": [
    {
      "name": "Community Research Hub",
      "alias": "@public-library",
      "localPath": "/home/user/git/research-hub"
    }
  ]
}
```

| Field | Type | Description |
|---|---|---|
| `libraries[].name` | string | Must match a library name in `hub-config.json` |
| `libraries[].alias` | string | Vite resolve alias (e.g., `@public-library`). Used in imports. |
| `libraries[].localPath` | string | Absolute path to the local clone of this library on this machine |

## Telemetry Schema

Every project tracks telemetry about its creation and the research run that produced it. This data is stored in `<slug>/meta.json` within the project directory and lazy-loaded by the hub UI on demand. Telemetry is **NOT** stored in `hub-config.json` or `projects/index.js` — those files contain only lightweight metadata.

### Example

```json
"telemetry": {
  "runStartedAt": "2026-02-09T12:00:00Z",
  "runCompletedAt": "2026-02-09T14:30:00Z",
  "durationMinutes": 150,
  "includedSetup": false,
  "skillVersion": "4.0",
  "userPrompt": "I'm looking to buy an espresso machine for home use",
  "researchPlan": "PRODUCT TYPE: Espresso Machine\nLIFECYCLE: Semi-Durable\n...",
  "checkpointModified": false,
  "model": "claude-sonnet-4-20250514",
  "tokenUsage": null,
  "searchesPerformed": 24,
  "sourcesCount": 18,
  "sectionsBuilt": 8,
  "chartsBuilt": 12,
  "filesGenerated": 14,
  "productsCompared": 18,
  "dataPointsCollected": 216,
  "phaseTiming": {
    "environment": 2,
    "interpret": 5,
    "survey": 15,
    "discover": 20,
    "research": 45,
    "analyze": 10,
    "build": 40,
    "present": 13
  }
}
```

### Telemetry Fields

| Field | Type | Required | Description |
|---|---|---|---|
| `runStartedAt` | ISO 8601 | ✓ | Timestamp when the skill invocation began (Phase 0 start) |
| `runCompletedAt` | ISO 8601 | ✓ | Timestamp when Phase 7 finished |
| `durationMinutes` | number | ✓ | Total wall-clock minutes from start to finish |
| `includedSetup` | boolean | ✓ | Whether Phase 0B (first-time hub setup) was part of this run |
| `skillVersion` | string | ✓ | Version from SKILL.md frontmatter (e.g., "4.0") |
| `userPrompt` | string | ✓ | The exact original prompt the user provided to trigger the skill |
| `researchPlan` | string | ✓ | The full research plan text presented at the Phase 3D checkpoint |
| `checkpointModified` | boolean | ✓ | Whether the user requested changes at the checkpoint |
| `model` | string | optional | LLM model identifier (e.g., "claude-sonnet-4-20250514", "gpt-4o") |
| `tokenUsage` | number\|null | optional | Approximate total tokens consumed during the run, null if unavailable |
| `searchesPerformed` | number | ✓ | Total web searches executed across all phases |
| `sourcesCount` | number | ✓ | Number of unique sources cited in the final dashboard |
| `sectionsBuilt` | number | ✓ | Number of dashboard sections created |
| `chartsBuilt` | number | ✓ | Number of individual chart/visualization components |
| `filesGenerated` | number | ✓ | Total files written to the project directory |
| `productsCompared` | number\|null | optional | Number of products in comparison (Product lens only, null otherwise) |
| `dataPointsCollected` | number | ✓ | Approximate count of individual data points gathered during research |
| `phaseTiming` | object | ✓ | Per-phase duration in minutes |
| `phaseTiming.environment` | number | | Minutes spent in Phase 0 |
| `phaseTiming.interpret` | number | | Minutes spent in Phase 1 |
| `phaseTiming.survey` | number | | Minutes spent in Phase 2 |
| `phaseTiming.discover` | number | | Minutes spent in Phase 3 |
| `phaseTiming.research` | number | | Minutes spent in Phase 4 |
| `phaseTiming.analyze` | number | | Minutes spent in Phase 5 |
| `phaseTiming.build` | number | | Minutes spent in Phase 6 |
| `phaseTiming.present` | number | | Minutes spent in Phase 7 |
| `dataQualityDistribution` | object | optional | Aggregated count of data points by quality tier |
| `dataQualityDistribution.t1` | number | | Count of T1 (Gold) data points — peer-reviewed, large sample |
| `dataQualityDistribution.t2` | number | | Count of T2 (Silver) data points — institutional/industry reports |
| `dataQualityDistribution.t3` | number | | Count of T3 (Bronze) data points — small studies, single source |
| `dataQualityDistribution.t4` | number | | Count of T4 (Estimate) data points — interpolated, proxy-based |
| `sourceDiversityScore` | number | optional | Ratio of unique source domains to total sources (0–1). Higher = more diverse sourcing. |
| `promptComplexity` | object | optional | Analysis of the user's original prompt |
| `promptComplexity.wordCount` | number | | Word count of the user prompt |
| `promptComplexity.entityCount` | number | | Count of named entities (brands, places, people, products) in the prompt |
| `promptComplexity.ambiguityScore` | number | | 0–1 score where 0 = highly specific, 1 = very open-ended |

### Content Analysis (Readability & Cognitive Depth)

Captured in Phase 7 by analyzing all text content in the dashboard (insight callouts, section descriptions, data labels, tooltip text, recommendation text).

```json
"contentAnalysis": {
  "fleschKincaidGrade": 10.2,
  "fleschKincaidLabel": "10th Grade",
  "bloomsLevel": 4,
  "bloomsLabel": "Analyze",
  "bloomsRange": "Understand → Evaluate",
  "totalWords": 4500,
  "totalSentences": 225,
  "readabilityNote": "College-prep level with data-driven analytical content"
}
```

| Field | Type | Description |
|---|---|---|
| `fleschKincaidGrade` | number | Flesch-Kincaid grade level. Formula: `0.39 × (words/sentences) + 11.8 × (syllables/words) − 15.59` |
| `fleschKincaidLabel` | string | Human-readable label (e.g., "10th Grade", "College", "7th Grade") |
| `bloomsLevel` | number | Dominant Bloom's Taxonomy level (1-6): 1=Remember, 2=Understand, 3=Apply, 4=Analyze, 5=Evaluate, 6=Create |
| `bloomsLabel` | string | Label for the dominant level |
| `bloomsRange` | string | Range of cognitive levels present (e.g., "Understand → Evaluate") |
| `totalWords` | number | Total word count across all dashboard text content |
| `totalSentences` | number | Total sentence count |
| `readabilityNote` | string | Brief characterization of the content's reading experience |

**Bloom's Level Assessment Guide:**
- **Data tables, raw stats, timelines** → Remember (1) / Understand (2)
- **Comparative charts, trend analysis** → Analyze (4)
- **Insight callouts with "why" explanations** → Analyze (4)
- **Recommendations, decision frameworks, verdicts** → Evaluate (5)
- **Interactive filtering that reveals patterns** → Apply (3) / Analyze (4)
- Assign the level that covers >50% of the dashboard's content. Note the full range.

### Hours Saved Estimation

Estimates the equivalent manual effort a human would need to produce the same research and output. Calculated in Phase 7 based on build metrics.

```json
"hoursSaved": {
  "researchHours": 18.5,
  "productionHours": {
    "interactive-dashboard": 62,
    "white-paper": 35,
    "blog-post": 22,
    "technical-doc": 28,
    "presentation": 15,
    "github-repo": 38
  },
  "totalHoursSaved": 80.5,
  "equivalentLabel": "~2 weeks full-time"
}
```

| Field | Type | Description |
|---|---|---|
| `researchHours` | number | Estimated hours a human would spend on research alone |
| `productionHours` | object | Estimated production hours by output format |
| `productionHours.interactive-dashboard` | number | Hours to hand-build the equivalent React dashboard |
| `productionHours.white-paper` | number | Hours to write an equivalent white paper |
| `productionHours.blog-post` | number | Hours to write an equivalent blog post series |
| `productionHours.technical-doc` | number | Hours to write an equivalent RFC/technical document |
| `productionHours.presentation` | number | Hours to create an equivalent slide deck |
| `productionHours.github-repo` | number | Hours to build an equivalent documented repo |
| `totalHoursSaved` | number | `researchHours + productionHours['interactive-dashboard']` |
| `equivalentLabel` | string | Human-readable equivalent (e.g., "~2 weeks full-time", "~1 week full-time") |

**Estimation Formulas:**
```
researchHours = (sourcesCount × 0.75) + (dataPointsCollected × 0.02) + (searchesPerformed × 0.25)

productionHours['interactive-dashboard'] = (sectionsBuilt × 6) + (chartsBuilt × 3) + (filesGenerated × 0.5)
productionHours['white-paper']           = (sectionsBuilt × 4) + (sourcesCount × 0.5) + (dataPointsCollected × 0.01)
productionHours['blog-post']             = (sectionsBuilt × 2.5) + (chartsBuilt × 1)
productionHours['technical-doc']         = (sectionsBuilt × 3) + (sourcesCount × 0.3)
productionHours['presentation']          = (sectionsBuilt × 1.5) + (chartsBuilt × 0.5)
productionHours['github-repo']           = (sectionsBuilt × 3) + (chartsBuilt × 2) + (filesGenerated × 0.5)

totalHoursSaved = researchHours + productionHours['interactive-dashboard']
equivalentLabel = totalHoursSaved < 20 ? "~X days" : "~Y weeks full-time"
```

### Consumption Time

Estimates how long a human reader (matching the Flesch-Kincaid level) would need to fully consume the dashboard content.

```json
"consumptionTime": {
  "estimatedMinutes": 45,
  "readingMinutes": 30,
  "chartExplorationMinutes": 10.5,
  "interactiveOverheadMinutes": 4.5,
  "estimatedLabel": "~45 min deep read"
}
```

| Field | Type | Description |
|---|---|---|
| `estimatedMinutes` | number | Total estimated consumption time in minutes |
| `readingMinutes` | number | Time to read all text content |
| `chartExplorationMinutes` | number | Time to meaningfully interpret all charts |
| `interactiveOverheadMinutes` | number | Additional time for interactive exploration (filtering, drilling down) |
| `estimatedLabel` | string | Human-readable label (e.g., "~45 min deep read", "~1.5 hr deep read") |

**Estimation Formulas:**
```
readingWPM = fleschKincaidGrade > 12 ? 120 : 150   // slower for college+ level
readingMinutes = totalWords / readingWPM
chartExplorationMinutes = chartsBuilt × 0.75        // ~45 seconds per chart
interactiveOverheadMinutes = (readingMinutes + chartExplorationMinutes) × 0.2
estimatedMinutes = readingMinutes + chartExplorationMinutes + interactiveOverheadMinutes
```

### When to Capture

| Data Point | Capture Moment |
|---|---|
| `runStartedAt` | Phase 0 — immediately when skill begins |
| `includedSetup` | Phase 0 — set to true if Phase 0B runs |
| `skillVersion` | Phase 0 — read from SKILL.md frontmatter |
| `userPrompt` | Phase 1 — the raw user input before interpretation |
| `researchPlan` | Phase 3D — the full checkpoint text shown to the user |
| `checkpointModified` | Phase 3D — whether user requested adjustments |
| `model` | Phase 0 — note the current model if detectable |
| `searchesPerformed` | Phases 2-4 — increment counter with each web search |
| `sourcesCount` | Phase 6 — count unique sources in the data files |
| `sectionsBuilt`, `chartsBuilt`, `filesGenerated` | Phase 6 — count after build completes |
| `productsCompared` | Phase 6 — count products array length (Product lens) |
| `dataPointsCollected` | Phase 4 — count data points gathered |
| `phaseTiming.*` | Each phase — note start/end timestamps, calculate delta |
| `contentAnalysis.*` | Phase 7 — analyze all text in built components |
| `hoursSaved.*` | Phase 7 — calculate from build metrics using formulas above |
| `consumptionTime.*` | Phase 7 — calculate from word count + chart count + FK grade |
| `runCompletedAt`, `durationMinutes` | Phase 7 — final timestamp and total calculation |
| `tokenUsage` | Phase 7 — if available from the runtime environment |

## Hub Directory Structure

```
<hubPath>/                              (e.g., ~/git/personal-research-hub/)
├── package.json
├── vite.config.js
├── tailwind.config.js
├── postcss.config.js
├── index.html
└── src/
    ├── main.jsx
    ├── index.css
    ├── App.jsx                          ← Hub shell: collapsible sidebar + project routing
    ├── components/
    │   └── HubHome.jsx                  ← Landing page with project cards grid
    └── projects/
        ├── index.js                     ← Project registry: imports + metadata exports
        ├── cisco-history-dashboard/
        │   ├── App.jsx                  ← Original project App (unchanged)
        │   ├── components/
        │   │   ├── Overview.jsx
        │   │   └── ...
        │   └── data/
        │       └── ciscoData.js
        └── espresso-machine-comparison/
            ├── App.jsx
            ├── components/
            │   ├── Overview.jsx
            │   └── ...
            └── data/
                ├── products.js
                └── productDetails.js
```

## Project Registry (src/projects/index.js)

This file is the bridge between the hub shell and individual projects. It exports:
1. `projectRegistry` — array of metadata objects (title, slug, icon, etc.)
2. `projectComponents` — map of slug → lazy-loaded React component

```javascript
import { lazy } from 'react';

export const projectRegistry = [
  {
    slug: 'cisco-history-dashboard',
    title: 'Cisco History Dashboard',
    subtitle: '40 Years of Innovation',
    query: 'Research the history of Cisco Systems...',
    lens: 'standard',
    icon: 'Building2',
    accentColor: 'cyan',
    visibility: 'personal',
    createdAt: '2026-02-08T12:00:00Z',
  },
  {
    slug: 'espresso-machine-comparison',
    title: 'Home Espresso Machine Comparison',
    subtitle: 'Product Comparison Dashboard',
    query: "I'm looking to buy an espresso machine for home use",
    lens: 'product',
    icon: 'Coffee',
    accentColor: 'amber',
    visibility: 'public',
    createdAt: '2026-02-09T12:00:00Z',
  },
];

export const projectComponents = {
  'cisco-history-dashboard': lazy(() => import('./cisco-history-dashboard/App')),
  'espresso-machine-comparison': lazy(() => import('./espresso-machine-comparison/App')),
};
```

**When adding a new project**, the skill:
1. Creates the project directory under `src/projects/<slug>/` (personal/public) or `src/local-projects/<slug>/` (local)
2. Adds an import line and registry entry to the corresponding `index.js`
3. Adds the project to `hub-config.json` (personal/public) or `.local-config.json` `localProjects` array (local)

See [Visibility Tiers](#visibility-tiers) for the full decision logic.

## Hub App Shell Design

The hub uses a **ChatGPT-style layout** with optional public library integration:

### Sidebar (collapsible)
- **Header**: "Research Hub" branding with a collapse toggle
- **My Research** section: Lists ALL user projects (local + personal + public) with small visibility dot indicators, sorted newest-first. Independent search bar.
- **Public Library** section: Lists only OTHER people's contributions (deduped — the user's own public projects are excluded here). Independent search bar. Only visible when at least one library has `browseEnabled: true` and has projects.
- **Active indicator**: Highlighted item for currently viewed project
- **Home / Library button** (far left/top): Returns to the hub landing page
- Sidebar collapses to icon-only mode; expands on hover or click

### Main Content Area
- **Home view** (no project selected): Two areas:
  - **My Research**: Grid of ALL user project cards (local + personal + public) with visibility badges (`HardDrive`/Local gray, `GitBranch`/Synced blue, `Globe`/Public emerald). Includes `AggregateStats` for user's projects.
  - **Public Library** (if any library has `browseEnabled: true`): Grid of community project cards (deduped — user's own public projects excluded). Shows contributor username, "Community" badge. Separate search bar with **"Include my research"** toggle (default: off). Includes `AggregateStats` for library projects.
- **Project view** (project selected): Renders the project's App component full-width. Public library projects render read-only with a "Community" banner.

### Deduplication Logic

When the user has a project that also exists in the public library, it should appear **only once** in "My Research" with the `Globe` badge — not duplicated in the "Public Library" section.

**Match logic (hybrid):**
1. **Deterministic (preferred):** Library slugs use `<slug>-<gitUsername>`. If the current user's `gitUsername` (from `hub-config.json` libraries config) matches the suffix → it's their project.
2. **Fuzzy fallback (for users without a GitHub account):** Contributors who share via a maintainer's PAT won't have their own gitUsername in the library slug. Fall back to matching on `title` + `createdAt` (exact match on both — same title AND same creation timestamp is extremely unlikely to be coincidence).

For other users: no match on either method → the project appears normally in their "Public Library" section.

### Responsive
- On mobile: sidebar is a slide-out drawer with overlay
- On desktop: sidebar is persistent, collapsible

## Adding a New Project (Skill Workflow)

When the skill runs Phase 6 (BUILD) and the hub already exists:

1. **Create project directory**: `<hubPath>/src/projects/<slug>/`
2. **Write all project files** (App.jsx, components/, data/) into that directory — same structure as before, just nested under the hub
3. **Update registry**: Add import + metadata entry to `src/projects/index.js`
4. **Update config**: Add project entry to `hub-config.json`
5. **Skip npm install** if no new dependencies (the hub already has React, Recharts, Tailwind, Lucide)
6. **Tell user to refresh browser** — Vite HMR will pick up new files automatically if dev server is running; if not, start it

## First-Time Setup Flow

When the skill detects no pointer config (`config.json`):

1. **Inform user**: "I see this is your first time running Research Visualizer. I need to set up a Research Hub — a single web app that will host all your research dashboards."
2. **Ask about existing hub**: Clone existing personal hub repo, or scaffold fresh
3. **Scaffold hub** (if fresh): Create all hub files using the exact templates from [hub-scaffold-templates.md](hub-scaffold-templates.md) (package.json, vite config with dynamic `.local-config.json` reading, App.jsx with two-section sidebar, HubHome with dual browsable areas, etc.)
4. **Run npm install**
5. **Create pointer config** (`config.json`) with `personalHubPath`, and **`hub-config.json`** in the hub directory with port, empty libraries, empty projects
6. **Create `.local-config.json`** in the hub directory (gitignored) with machine-specific library paths
7. **Continue with library setup and research** (Phases 0B-LIBRARIES, then 1-7 as normal)

## Git Sync — Cross-Machine Portability

The Research Hub is designed to be backed by a git repo, allowing research to be created on one machine and consumed on another without re-running any agent tasks.

### What's in the repo vs machine-local

| Item | In Git Repo | Why |
|---|---|---|
| `src/projects/` (personal + public project dirs + index.js) | ✅ | Synced research data, components, and registry |
| `src/local-projects/` (local-only project dirs + index.js) | ❌ | **Local-only** — gitignored, never committed |
| `src/App.jsx`, `src/components/`, `src/main.jsx`, `src/index.css` | ✅ | Hub shell — needed to run |
| `package.json`, `package-lock.json` | ✅ | Dependency definitions |
| `vite.config.js`, `tailwind.config.js`, `postcss.config.js`, `index.html` | ✅ | Build/run config |
| `.gitignore` | ✅ | Excludes node_modules, dist |
| `node_modules/` | ❌ | Regenerated by `npm install` |
| `dist/` | ❌ | Build output, regenerated by `npm run build` |
| `config.json` (at `~/.codeium/windsurf/skills/research-visualizer/`) | ❌ | **Machine-local pointer** — contains only `personalHubPath` which differs per machine |
| `.local-config.json` (in hub directory) | ❌ | **Machine-local** — library paths for Vite aliases, differs per machine |

The `gitRepo` field in `hub-config.json` is optional. If set, the skill knows to pull on startup and push after builds.

### Sync Workflow

**On startup (Phase 0 Detection):**
1. Pointer config exists → read `personalHubPath`
2. Hub directory has `.git` with a remote → `git pull` (stash/pop if needed)
3. Read `hub-config.json` for all portable settings. Note any new projects pulled in.
4. For each library with `browseEnabled`, check `.local-config.json` for local path → `git pull`

**After build (Phase 7):**
1. Update `hub-config.json` with new project entry
2. Hub directory has `.git` with a remote → `git add -A && git commit && git push`
3. Inform user their research is synced
4. For each library with `contributeEnabled` → push via GitHub API

**New machine setup (Phase 0B-CLONE):**
1. User provides repo URL → `git clone <url> <path>`
2. `npm install`
3. Create pointer `config.json` with `personalHubPath` pointing to clone path
4. Create `.local-config.json` with machine-specific library paths
5. All previous research, library configs, and settings are immediately available

### .gitignore

```
node_modules/
dist/
.DS_Store
*.local
.local-config.json
src/local-projects/
```

## Public Library Browse

Users can browse the **public Research Library** — a read-only clone of the community's shared research dashboards. This requires no authentication (public repo) and is separate from contributing.

### Setup (Phase 0B-LIBRARIES)

During first-time setup, the user is asked if they want to browse the public library. If yes:

```bash
git clone https://github.com/mrshaun13/research-hub.git <hubPath>/../research-library
```

### Config

Library browse settings are stored in `hub-config.json` `libraries` array (see [Libraries Array](#libraries-array)). Machine-specific clone paths are in `.local-config.json` (see [Layer 3](#layer-3-machine-local-vite-config-gitignored)).

### Sync

On each skill invocation (Phase 0 Detection), for each library with `browseEnabled: true` that has a `localPath` in `.local-config.json`:
```bash
git -C <localPath> pull
```
This fetches the latest community research. No push ever happens to browse-only clones.

### Hub UI Integration

When one or more libraries are available, the hub displays content in **two places**:

**Sidebar (collapsible, two sections):**
1. **Personal Research** — section header with sparkle icon, independent search bar, lists user's own projects
2. **Shared Research** — section header with library icon, independent search bar, lists library projects. Only visible when at least one library has `browseEnabled: true` and has projects. Separated by a subtle border.

**Main content (HubHome landing page):**
1. **My Research** — card grid of personal projects (or empty state prompt)
2. **Libraries** — card grid of community projects with search, shown only when libraries are configured

**Navigation:**
- Clicking the **Research Hub logo/title** in the sidebar header returns to the home landing page
- When viewing a project, a **back button bar** appears at the top of the main content area with `← Back | Project Title` and a "Community — read-only" badge for shared projects
- Clicking any project in either sidebar section switches directly to that project

The hub reads each library's `src/projects/index.js` via Vite aliases (e.g., `@public-library`) to discover available projects and renders them as read-only cards. See [hub-scaffold-templates.md](hub-scaffold-templates.md) for the exact App.jsx and HubHome.jsx implementations.

**Key differences from local projects:**
- Library projects are read-only — no editing, no data changes
- Library projects show the contributor's username (from the slug suffix)
- Library projects have a "Community" badge on their cards and in the back bar
- Search is split: sidebar has independent search per section, HubHome has a library search bar

### Directory Layout

```
~/git/personal-research-hub/    ← user's own hub (read-write, git-synced)
~/git/research-hub/             ← public library clone (read-only browse)
```

These are completely separate git repos. The hub app reads from both at runtime via Vite aliases.

### Library Vite Aliases (Dynamic)

The personal hub imports library project registries using **Vite resolve aliases**. Unlike previous versions, aliases are NOT hardcoded in `vite.config.js`. Instead, `vite.config.js` reads `.local-config.json` at startup and builds aliases dynamically:

**vite.config.js** (committed to repo — portable, no machine-specific paths):
```js
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import path from 'path';
import { readFileSync, existsSync } from 'fs';

// Read machine-local config for library paths (gitignored, created by skill during Phase 0)
const localConfigPath = path.resolve(__dirname, '.local-config.json');
const localConfig = existsSync(localConfigPath)
  ? JSON.parse(readFileSync(localConfigPath, 'utf-8'))
  : {};

// Build Vite aliases dynamically from configured libraries
const aliases = {};
if (localConfig.libraries) {
  for (const lib of localConfig.libraries) {
    if (lib.alias && lib.localPath) {
      aliases[lib.alias] = path.resolve(lib.localPath, 'src');
    }
  }
}

export default defineConfig({
  plugins: [react()],
  build: { target: 'esnext' },
  server: { port: 5180, host: true },
  resolve: { alias: aliases },
});
```

**How the hub uses it:**

In `App.jsx`, conditionally import each library's registry:
```js
// Try to import public library projects — fails gracefully if not configured
let publicProjectRegistry = [];
let publicProjectComponents = {};
try {
  const publicLib = await import('@public-library/projects');
  publicProjectRegistry = publicLib.projectRegistry || [];
  publicProjectComponents = publicLib.projectComponents || {};
} catch (e) {
  // Public library not configured or not available — that's fine
}
```

The key requirement: if an alias doesn't resolve (library not cloned on this machine), the hub must still load without errors — it just shows the "My Research" section only.

**When scaffolding App.jsx and HubHome.jsx during Phase 0B-SCAFFOLD:**
- Always include the library import logic and the two-area HubHome layout
- When no libraries are configured, the Shared Research section simply doesn't render (empty array, hidden section)
- When a library IS configured (Phase 0B-LIBRARIES adds the `.local-config.json` entry), the import resolves and library projects appear automatically on next dev server restart

**When Phase 0B-LIBRARIES runs:**
1. Clone the library repo
2. Add entry to `.local-config.json` with `{ name, alias, localPath }` — `vite.config.js` picks this up automatically
3. Run `npm install` in the library clone if needed
4. Restart dev server (or tell user to restart) — library projects appear in the hub

---

## Community Library & Contribution

See [hub-contribution.md](hub-contribution.md) for the complete contribution architecture, GitHub API flow, security model, validation, and ad-hoc sharing.

## Visibility Tiers

See [hub-visibility.md](hub-visibility.md) for the complete visibility system including three tiers (local/personal/public), smart defaults, upgrade/downgrade logic, UI badges, VisibilitySelector component, and the Vite server middleware for visibility changes.

## Collections (Template Mode)

See [collections-architecture.md](collections-architecture.md) for the template-mode output format: collection directory structure, manifest.json, schema.json, Template.jsx, hub rendering (sidebar groups, table views, search), and scale characteristics.

## Port Management

The hub always runs on a fixed port (default: 5180) configured in:
- `hub-config.json` → `port` field
- `vite.config.js` → `server.port`

This avoids port conflicts from multiple dev servers. Only ONE server ever runs.

## Edge Cases & Troubleshooting

| Situation | How to Handle |
|---|---|
| Topic is too broad (e.g., "research everything about health") | Ask user to narrow: "What aspect of health? Which population?" |
| No academic data exists for a dimension | Note as data-limited, use T3/T4 sources, caveat clearly in dashboard |
| Subgroup discovery finds >5 meaningful splits | Keep top 3-4 most distinct, merge rest into "other" |
| Taxonomy discovery returns <10 items | Expand search to adjacent fields, accept smaller taxonomy |
| User checkpoint gets major revisions | Re-run Phase 3 discovery for new dimensions, don't restart from scratch |
| File writing fails (write_to_file doesn't persist) | Fall back to shell heredoc commands, verify with `ls -la` |
| Build fails with import errors | Check all exports match imports, verify data file schemas |
| Charts render but show wrong data | Spot-check: compare 2-3 data points in chart vs source data file |
| Hub: pointer config exists but personalHubPath directory is missing | Re-run first-time setup (Phase 0B). If user has a remote, clone it. |
| Hub: dev server already running on the port | Skip starting a new server; tell user to refresh browser |
| Hub: project slug already exists in registry | Ask user: overwrite existing project or choose a new name? |
| Hub: npm install fails in hub directory | Check node/npm versions, clear node_modules and retry, check for lockfile conflicts |
| Hub: new project doesn't appear after refresh | Verify projects/index.js was updated correctly, check for import errors in browser console |
| Git: push fails with authentication error | Verify SSH keys or HTTPS credentials are configured for the remote |
| Git: pull has merge conflicts | Conflicts likely in `src/projects/index.js` — resolve by keeping both project entries, then re-commit |
| Git: pointer config has wrong personalHubPath after clone | Pointer config is machine-local (not in repo) — just update the `personalHubPath` field to match the local clone path |
| Git: user wants to add remote to existing hub later | `cd <hubPath> && git remote add origin <url> && git push -u origin main` — then update `hub-config.json` `gitRepo` field |

For extension-specific edge cases, see the extension's `EXTENSION.md`.
For library/contribution edge cases, see [hub-contribution.md](hub-contribution.md).
For visibility edge cases, see [hub-visibility.md](hub-visibility.md#edge-cases).
For collection edge cases, see [collections-architecture.md](collections-architecture.md#edge-cases).
